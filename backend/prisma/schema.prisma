// =========================================================
// GENERATOR & DATASOURCE
// =========================================================
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================
// USER MODEL
// =========================================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user")  // user, admin
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// =========================================================
// SESSION MODEL
// =========================================================
model Session {
  id          String     @id @default(cuid())
  name        String     @default("default")
  sessionId   String     @unique
  status      String     @default("stopped")
  qrCode      String?
  phoneNumber String?
  isDefault   Boolean    @default(true)

  // Job tracking untuk anti-suspend
  jobCount         Int       @default(0)      // Jumlah job yang sudah dikerjakan
  jobLimitReached  Boolean   @default(false)  // Flag jika sudah mencapai limit
  lastJobAt        DateTime?                  // Waktu job terakhir
  restingUntil     DateTime?                  // Waktu istirahat sampai kapan

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  campaigns   Campaign[]
  contacts    Contact[]

  @@map("sessions")
}

// =========================================================
// CONTACT MODEL
// =========================================================
model Contact {
  id          String    @id @default(cuid())
  name        String
  phoneNumber String
  email       String?
  tags        String[]  @default([])
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  messages    Message[] @relation("ContactMessages")

  @@unique([phoneNumber, sessionId])
  @@map("contacts")
}

// =========================================================
// CAMPAIGN MODEL
// =========================================================
model Campaign {
  id            String     @id @default(cuid())
  name          String

  // single message (fallback)
  message       String     @db.Text

  // multi-variant messages
  variants      String[]   @default([])

  imageUrl      String?
  status        String      @default("draft") // draft, sending, sent, failed

  sessionId     String
  session       Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  scheduledAt   DateTime?
  sentAt        DateTime?

  totalContacts Int         @default(0)
  sentCount     Int         @default(0)
  failedCount   Int         @default(0)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  buttons       Button[]

  // relation ke Message logs
  messages      Message[]   @relation("CampaignMessages")

  @@map("campaigns")
}

// =========================================================
// BUTTON MODEL
// =========================================================
model Button {
  id          String    @id @default(cuid())

  campaignId  String
  campaign    Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  label       String
  url         String
  order       Int       @default(1) // 1 or 2

  createdAt   DateTime  @default(now())

  @@map("buttons")
}

// =========================================================
// MESSAGE LOG MODEL
// =========================================================
model Message {
  id          String    @id @default(cuid())

  campaignId  String
  contactId   String

  // relasi ke campaign
  campaign    Campaign @relation("CampaignMessages", fields: [campaignId], references: [id], onDelete: Cascade)

  // relasi ke contact
  contact     Contact  @relation("ContactMessages", fields: [contactId], references: [id], onDelete: Cascade)

  status      String    @default("pending") // pending, sent, delivered, failed
  waMessageId String?
  errorMsg    String?

  sentAt      DateTime?
  deliveredAt DateTime?

  createdAt   DateTime  @default(now())

  @@map("messages")
}
